name: Reusable Terraform Setup

on:
  workflow_call:
    inputs:
      terraform-version:
        description: "Terraform version to use"
        required: true
        type: string
      working-directory:
        description: "Working directory for Terraform"
        required: false
        type: string
        default: "infra"
      with-backend:
        description: "Whether to initialise with backend (requires AWS credentials)"
        required: false
        type: boolean
        default: false
    outputs:
      terraform-cache-key:
        description: "Cache key for Terraform providers"
        value: ${{ jobs.setup.outputs.terraform-cache-key }}

jobs:
  setup:
    name: Setup Terraform Environment
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      terraform-cache-key: ${{ steps.cache-providers.outputs.cache-key }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform-version }}
          terraform_wrapper: false

      - name: Configure Terraform plugin cache
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo 'plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"' > ~/.terraformrc

      - name: Cache Terraform providers
        id: cache-providers
        uses: actions/cache@v4
        with:
          path: ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-terraform-v1-${{ inputs.terraform-version }}-${{ hashFiles(format('{0}/.terraform.lock.hcl', inputs.working-directory)) }}
          restore-keys: |
            ${{ runner.os }}-terraform-v1-${{ inputs.terraform-version }}-
            ${{ runner.os }}-terraform-v1-

      - name: Terraform Init
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "Initialising Terraform..."
          if [ "${{ inputs.with-backend }}" = "true" ]; then
            terraform init -input=false
            echo "✅ Terraform initialisation with backend completed"
          else
            terraform init -backend=false -input=false
            echo "✅ Terraform initialisation without backend completed"
          fi 